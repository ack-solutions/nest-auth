name: Publish Packages (tag)

on:
  push:
    tags:
      - "v*.*.*"
      - "*.*.*"
      - "v*.*.*-beta*"
      - "*.*.*-beta*"
  workflow_dispatch:

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write

    steps:
      - name: Checkout (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: https://registry.npmjs.org
          cache: pnpm

      - name: Extract version from tag
        id: v
        shell: bash
        run: |
          echo "üîç Extracting version from tag..."
          TAG="${GITHUB_REF#refs/tags/}"
          VERSION="${TAG#v}"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "üìå Tag: $TAG"
          echo "üì¶ Version: $VERSION"
          
          # Detect if this is a pre-release version (beta, alpha, rc, etc.)
          if [[ "$VERSION" =~ -(beta|alpha|rc|pre) ]]; then
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
            echo "dist_tag=beta" >> $GITHUB_OUTPUT
            DIST_TAG="beta"
            echo "‚úÖ Detected pre-release version (beta/alpha/rc/pre)"
          else
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
            echo "dist_tag=latest" >> $GITHUB_OUTPUT
            DIST_TAG="latest"
            echo "‚úÖ Detected stable version"
          fi
          echo "üè∑Ô∏è  Dist-tag: $DIST_TAG"

      - name: Ensure tag was created from main HEAD
        shell: bash
        run: |
          echo "üîç Verifying tag is on main HEAD..."
          TAG="${{ steps.v.outputs.tag }}"
          echo "üìå Checking tag: $TAG"
          
          # Fetch main branch first
          echo "‚¨áÔ∏è  Fetching origin/main..."
          git fetch origin main
          
          TAG_COMMIT="$(git rev-list -n 1 "$TAG" 2>/dev/null || echo '')"
          MAIN_COMMIT="$(git rev-parse origin/main)"
          
          echo "üìç Tag commit: ${TAG_COMMIT:0:7}"
          echo "üìç Main commit: ${MAIN_COMMIT:0:7}"
          
          if [ -z "$TAG_COMMIT" ]; then
            echo "‚ùå Tag '$TAG' not found!"
            exit 1
          fi
          
          if [ "$TAG_COMMIT" != "$MAIN_COMMIT" ]; then
            echo "‚ùå Tag is not pointing to latest origin/main. Create the tag from main HEAD."
            exit 1
          fi
          echo "‚úÖ Tag is on main HEAD"

      - name: Install dependencies
        run: |
          echo "üì¶ Installing dependencies..."
          pnpm install --frozen-lockfile
          echo "‚úÖ Dependencies installed"

      - name: Bump all workspace package versions to tag version
        shell: bash
        run: |
          VERSION="${{ steps.v.outputs.version }}"
          echo "üîÑ Bumping package versions to: $VERSION"
          echo ""
          
          # Show current versions before bumping
          echo "üìä Current package versions (before bump):"
          for pkg_dir in packages/*/; do
            if [ -f "$pkg_dir/package.json" ]; then
              PKG_NAME=$(grep -o '"name":\s*"[^"]*"' "$pkg_dir/package.json" | head -1 | cut -d'"' -f4)
              PKG_VERSION=$(grep -o '"version":\s*"[^"]*"' "$pkg_dir/package.json" | head -1 | cut -d'"' -f4)
              IS_PRIVATE=$(grep -o '"private":\s*true' "$pkg_dir/package.json" > /dev/null && echo "true" || echo "false")
              if [ "$IS_PRIVATE" != "true" ] && [ -n "$PKG_NAME" ]; then
                echo "  - $PKG_NAME: $PKG_VERSION -> $VERSION"
              fi
            fi
          done
          echo ""
          
          # Bump version for every package in the workspace (pnpm will skip private packages)
          echo "üöÄ Running: pnpm -r version \"$VERSION\" --no-git-tag-version"
          pnpm -r version "$VERSION" --no-git-tag-version --no-commit-hooks || {
            echo "‚ùå Failed to bump versions"
            exit 1
          }
          echo ""
          
          # Show updated versions
          echo "‚úÖ Updated package versions (after bump):"
          for pkg_dir in packages/*/; do
            if [ -f "$pkg_dir/package.json" ]; then
              PKG_NAME=$(grep -o '"name":\s*"[^"]*"' "$pkg_dir/package.json" | head -1 | cut -d'"' -f4)
              PKG_VERSION=$(grep -o '"version":\s*"[^"]*"' "$pkg_dir/package.json" | head -1 | cut -d'"' -f4)
              IS_PRIVATE=$(grep -o '"private":\s*true' "$pkg_dir/package.json" > /dev/null && echo "true" || echo "false")
              if [ "$IS_PRIVATE" != "true" ] && [ -n "$PKG_NAME" ]; then
                echo "  - $PKG_NAME: $PKG_VERSION"
              fi
            fi
          done
          echo ""
          
          # Show what files changed
          echo "üìù Changed files:"
          git status --short || true

      - name: Commit version changes back to main
        shell: bash
        run: |
          echo "üíæ Committing version changes..."
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Check if there are changes
          if git diff --quiet && git diff --cached --quiet; then
            echo "‚ÑπÔ∏è  No version changes to commit (versions already match tag)."
          else
            echo "üìù Staging changes..."
            git add -A
            
            echo "üìã Changes to be committed:"
            git diff --cached --stat || git diff --stat || true
            echo ""
            
            echo "üí¨ Committing changes..."
            git commit -m "chore(release): v${{ steps.v.outputs.version }}" || {
              echo "‚ùå Failed to commit changes"
              exit 1
            }
            
            echo "‚¨ÜÔ∏è  Pushing to origin/main..."
            git push origin HEAD:main || {
              echo "‚ùå Failed to push to origin/main"
              exit 1
            }
            echo "‚úÖ Version changes committed and pushed"
          fi

      - name: Move the tag to the release commit (keep tag = published code)
        shell: bash
        run: |
          TAG="${{ steps.v.outputs.tag }}"
          echo "üè∑Ô∏è  Moving tag '$TAG' to current commit..."
          CURRENT_COMMIT=$(git rev-parse HEAD)
          echo "üìç Current commit: ${CURRENT_COMMIT:0:7}"
          
          git tag -f "$TAG" || {
            echo "‚ùå Failed to update tag"
            exit 1
          }
          
          echo "‚¨ÜÔ∏è  Pushing tag to origin..."
          git push origin -f "$TAG" || {
            echo "‚ùå Failed to push tag"
            exit 1
          }
          echo "‚úÖ Tag moved and pushed"

      - name: Build all packages
        run: |
          echo "üî® Building all packages..."
          pnpm build || {
            echo "‚ùå Build failed"
            exit 1
          }
          echo "‚úÖ Build completed"

      - name: Publish all packages
        shell: bash
        run: |
          DIST_TAG="${{ steps.v.outputs.dist_tag }}"
          VERSION="${{ steps.v.outputs.version }}"
          
          echo "üì¶ Publishing packages..."
          echo "üè∑Ô∏è  Dist-tag: $DIST_TAG"
          echo "üìå Version: $VERSION"
          echo ""
          
          # List packages that will be published (excluding private)
          echo "üìã Packages to publish:"
          for pkg_dir in packages/*/; do
            if [ -f "$pkg_dir/package.json" ]; then
              PKG_NAME=$(grep -o '"name":\s*"[^"]*"' "$pkg_dir/package.json" | head -1 | cut -d'"' -f4)
              PKG_VERSION=$(grep -o '"version":\s*"[^"]*"' "$pkg_dir/package.json" | head -1 | cut -d'"' -f4)
              IS_PRIVATE=$(grep -o '"private":\s*true' "$pkg_dir/package.json" > /dev/null && echo "true" || echo "false")
              if [ "$IS_PRIVATE" != "true" ] && [ -n "$PKG_NAME" ]; then
                echo "  - $PKG_NAME@$PKG_VERSION"
              fi
            fi
          done
          echo ""
          
          # Check npm authentication
          echo "üîê Checking npm authentication..."
          npm whoami || {
            echo "‚ùå Not authenticated to npm"
            exit 1
          }
          echo "‚úÖ Authenticated to npm"
          echo ""
          
          # Publish packages
          if [ "${{ steps.v.outputs.is_prerelease }}" = "true" ]; then
            echo "üöÄ Publishing pre-release version with dist-tag: $DIST_TAG"
            pnpm -r publish --access public --no-git-checks --provenance --tag "$DIST_TAG" || {
              echo "‚ùå Failed to publish packages"
              exit 1
            }
          else
            echo "üöÄ Publishing stable version with dist-tag: latest"
            pnpm -r publish --access public --no-git-checks --provenance || {
              echo "‚ùå Failed to publish packages"
              exit 1
            }
          fi
          echo ""
          echo "‚úÖ All packages published successfully!"
          
          # Verify published packages
          echo ""
          echo "üîç Verifying published packages:"
          for pkg_dir in packages/*/; do
            if [ -f "$pkg_dir/package.json" ]; then
              PKG_NAME=$(grep -o '"name":\s*"[^"]*"' "$pkg_dir/package.json" | head -1 | cut -d'"' -f4)
              PKG_VERSION=$(grep -o '"version":\s*"[^"]*"' "$pkg_dir/package.json" | head -1 | cut -d'"' -f4)
              IS_PRIVATE=$(grep -o '"private":\s*true' "$pkg_dir/package.json" > /dev/null && echo "true" || echo "false")
              if [ "$IS_PRIVATE" != "true" ] && [ -n "$PKG_NAME" ]; then
                echo -n "  - $PKG_NAME@$PKG_VERSION: "
                if npm view "$PKG_NAME@$PKG_VERSION" version >/dev/null 2>&1; then
                  echo "‚úÖ Published"
                else
                  echo "‚ùå Not found"
                fi
              fi
            fi
          done
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
